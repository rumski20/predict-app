<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Predict</title>
    <!--[if lt IE 9]><script src="js/html5shiv-printshiv.js" media="all"></script><![endif]-->

    <style type="text/css">
    /*icon styling*/
    @import url(http://weloveiconfonts.com/api/?family=fontawesome);

    /* fontawesome */
    [class*="fontawesome-"]:before {
      font-family: 'FontAwesome', sans-serif;
    }

    .tg {
        border-collapse: collapse;
        border-spacing: 0;
        border-color: #aaa;
    }
    .tg td {
        font-family: Arial, sans-serif;
        font-size: 14px;
        padding: 10px 5px;
        border-style: solid;
        border-width: 0px;
        overflow: hidden;
        word-break: normal;
        border-color: #aaa;
        color: #333;
        background-color: #fff;
        border-top-width: 1px;
        border-bottom-width: 1px;
        text-align: center;
    }
    .tg th {
        font-family: Arial, sans-serif;
        font-size: 14px;
        font-weight: normal;
        padding: 10px 12px;
        border-style: solid;
        border-width: 0px;
        overflow: hidden;
        word-break: normal;
        border-color: #aaa;
        color: #fff;
        background-color: #f38630;
        border-top-width: 1px;
        border-bottom-width: 1px;
    }
    .tg .tg-header {
        background-color: #6200c9
    }
    .tg .tg-data {
        background-color: #cbcefb
    }
    </style>

</head>

<body>

    <h3> Batting </h3>
    <textarea id="batBin" class="pasteValues" cols="100" rows="10"></textarea>

    <div id="bat">
        <table id="batTable" class="tg">
            <thead>
                <tr>
                    <th class="tg-header">Name</th>
                    <th class="tg-header">Dur</th>
                    <th class="tg-header">Health</th>
                    <!-- <th class="tg-header">AB</th> -->
                    <th class="tg-header">AVG</th>
                    <th class="tg-header">OBP</th>
                    <th class="tg-header">SLG</th>
                    <!-- <th class="tg-header">Rc27</th> -->
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <h3> Pitching </h3>
    <textarea id="pitBin" class="pasteValues" cols="100" rows="10"></textarea>

    <div id="pit">
        <table id="pitTable" class="tg">
            <thead>
                <tr>
                    <th class="tg-header">Name</th>
                    <th class="tg-header">Dur</th>
                    <th class="tg-header">Health</th>
                    <th class="tg-header">Stamina</th>
                    <th class="tg-header">OPS</th>
                    <th class="tg-header">WHIP</th>
                    <th class="tg-header">FIP</th>
                    <!-- <th class="tg-header">Rc27</th> -->
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>



    <script type="text/javascript">

    // paste raw value bins
    var bins = document.getElementsByClassName("pasteValues");
    for (var i = 0; i < bins.length; ++i) {
        bins[i].onchange = handleValues;
    }

    // set column click listeners for table sorting
    var cols = document.getElementsByClassName("tg-header");
    for (var i = 0; i < cols.length; ++i) {
        // add sort table listener
        cols[i].onclick = headerSortHandler;
    }

    // create caret nodes
    var caretUp = document.createElement('span');
    caretUp.className = "fontawesome-sort-up";
    var caretDown = document.createElement('span');
    caretDown.className = "fontawesome-sort-down";


    function headerSortHandler(event) {
        event.stopPropagation();
        console.log(this);
        // add caret indicators, get direction of sort
        var dir = indicateWithCaret(this);
        // get parent
        var table = getTableParent(this);
        // get column index
        var colIndex = Array.prototype.indexOf.call(this.parentNode.children, this);
        // sort table
        sortTable(table, colIndex, dir);
        //symbolize column
        symbolizeColumn(this, table, colIndex);
    }

    function handleValues(event) {
        console.log(this.value);
        var tempArray = this.value.split('\n'),
            valArray = [];
        console.log(tempArray);
        tempArray.forEach(
            function(val, ind) {
                if (val.length > 1) {
                    // alter array based on it's sequence
                    // and add it to list of lists
                    valArray.push(cleanUpValues(val.split('\t')));
                }
            }
        );
        // alter array depending on where it was copied from
        // valArray = cleanUpValues(valArray);

        console.log(valArray);
        // check for which one
        if (this.id == 'batBin') {
            clearTable('bat');
            populateTable(valArray, 'bat');
        } else {
            clearTable('pit');
            populateTable(valArray, 'pit');
        }
    }

    function populateTable(data, type) {
        // data is an array of arrays
        // Find a <table> element with id="myTable":
        var table = document.getElementById(type + "Table").tBodies[0];
        // loop through formatted data
        data.forEach(
            function(player, ind) { // player is an array of values
                var row = table.insertRow(-1); // insert row
                row.insertCell(0).innerHTML = player[0];
                row.insertCell(1).innerHTML = player[4];
                row.insertCell(2).innerHTML = player[5];
                if (type == 'bat') {
                    row.insertCell(3).innerHTML = roundy(predict(player, 'AVG'), 3);
                    row.insertCell(4).innerHTML = roundy(predict(player, 'OBP'), 3);
                    row.insertCell(5).innerHTML = roundy(predict(player, 'SLG'), 3);
                    // row.insertCell(7).innerHTML = roundy(predict(player, 'Rc27'), 2);
                } else { // pitching
                    row.insertCell(3).innerHTML = player[6];
                    row.insertCell(4).innerHTML = roundy(predict(player, 'OPS'), 3);
                    row.insertCell(5).innerHTML = roundy(predict(player, 'WHIP'), 2);
                    row.insertCell(6).innerHTML = roundy(predict(player, 'FIP'), 2);
                }
            }
        )
    }

    function predict(playerData, stat) {
        console.log(playerData, stat);
        var predValue = data[stat].Intercept;
        for (var rating in data[stat]) {
            switch (rating) {
                case 'CN':
                    predValue += data[stat].CN * parseInt(playerData[6]);
                    break;
                case 'PW':
                    predValue += data[stat].PW * parseInt(playerData[7]);
                    break;
                case 'LH':
                    predValue += data[stat].LH * parseInt(playerData[8]);
                    break;
                case 'RH':
                    predValue += data[stat].RH * parseInt(playerData[9]);
                    break;
                case 'BE':
                    predValue += data[stat].BE * parseInt(playerData[10]);
                    break;
                case 'SP':
                    predValue += data[stat].SP * parseInt(playerData[11]);
                    break;
                case 'CT':
                    predValue += data[stat].CT * parseInt(playerData[7]);
                    break;
                case 'LH.1':
                    predValue += data[stat]['LH.1'] * parseInt(playerData[8]);
                    break;
                case 'RH.1':
                    predValue += data[stat]['RH.1'] * parseInt(playerData[9]);
                    break;
                case 'VE':
                    predValue += data[stat].VE * parseInt(playerData[10]);
                    break;
                case 'GB':
                    predValue += data[stat].GB * parseInt(playerData[11]);
                    break;
                case 'P1':
                    predValue += data[stat].P1 * parseInt(playerData[12]);
                    break;
                case 'P2':
                    predValue += data[stat].P2 * parseInt(playerData[13]);
                    break;
                case 'P3':
                    predValue += data[stat].P3 * parseInt(playerData[14]);
                    break;
                case 'P5':
                    predValue += data[stat].P5 * parseInt(playerData[16]);
                    break;
            }
            console.log(rating, predValue);
        }
        console.log(predValue);
        return predValue;
    }

    function roundy(value, decimals) {
        return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
    }

    function clearTable(type) {
        var table = document.getElementById(type + "Table").tBodies[0];
        for (var i = table.rows.length - 1; i > 0; i--) {
            table.deleteRow(i);
        }
    }

    // Name (bats) Age Pos %   Durability  Health  Contact Power   Batting Versus Left-Handed Pitching Batting Versus Right-Handed Pitching    Batting Eye Speed   Range   Glove   Arm Strength    Arm Accuracy    Pitch Calling   $
    // Rule 5 Draftee Jeffrey Beckett (S)  26  1B  100 77  44  29  88  41  57  79  46  39  28  30  36  1   $327K
    // Ernest Coffey (L)   25  LF  100 70  47  80  45  69  57  57  23  43  33  41  40  18  $55K

    // Player  Pos Age Durability  Health  Stamina Control Effectiveness Versus Left-Handed Batting    Effectiveness Versus Right-Handed Batting   Velocity    Groundball/Flyball Tendency Pitch 1 Pitch 2 Pitch 3 Pitch 4 Pitch 5 $   Action
    // Esteban Volquez (L) P   21  34  100 82  41  49  40  90  48  69  64  46  34  42  $300K   Negotiate

    // Player   Frn Pos %   Age  Durability  Health  Contact     Power   Batting Versus Left-Handed Pitching     Batting Versus Right-Handed Pitching    Batting Eye     Base Running    Speed   Range   Glove   Arm Strength    Arm Accuracy    Pitch Calling  Yr  $   Action

    function cleanUpValues(playerData) {
        console.log(playerData);
        var countAlpha = 0;
        // playerData is an array of values
        for (var i = 0; i < playerData.length; i++) {
            console.log(playerData[i]);
            // normal
            if (/^\d+$/.test(playerData[i]) && i == 1) {
                console.log(playerData);
                return playerData;
            }
            // IFA
            else if (/^\d+$/.test(playerData[i]) && i == 2) {
                playerData.splice(3, 0, ""); // add empty slot to array
                console.log(playerData);
                return playerData;
            }
            // waiver, trade list
            if (!/^\d+$/.test(playerData[i])) {
                countAlpha++;
                if (countAlpha > 2) {
                    playerData.splice(3, 1); // remove percentage from arr
                    console.log(playerData);
                    return playerData;
                }
            }
        }
    }

    // sort table by row
    // http://stackoverflow.com/questions/14267781/sorting-html-table-with-js
    function sortTable(table, col, reverse) {
        console.log(table, col, reverse);
        var tb = table.tBodies[0], // use `<tbody>` to ignore `<thead>` and `<tfoot>` rows
        tr = Array.prototype.slice.call(tb.rows, 0), // put rows into array
        i;
        console.log(tb);
        reverse = -((+reverse) || -1);
        tr = tr.sort(function(a, b) { // sort rows
            return reverse // `-1 *` if want opposite order
                * (a.cells[col].textContent.trim() // using `.textContent.trim()` for test
                    .localeCompare(b.cells[col].textContent.trim())
                );
        });
        for (i = 0; i < tr.length; ++i) tb.appendChild(tr[i]); // append each row in order
    }

    // get table parent of clicked header
    function getTableParent(element) {
        var parent = element.parentNode;
        var tagName = "table";

        while (parent) { //Loop through until you find the desired parent tag name
            if (parent.tagName && parent.tagName.toLowerCase() == tagName) {
                return parent;
            } else {
                parent = parent.parentNode;
            }
        }
    }

    // add or remove carets as necessary
    function indicateWithCaret(el) {
        var direction;
        // check if header already has one
        if ( el.contains(caretUp) ) {
            el.replaceChild(caretDown, caretUp);
            return direction = true;
        } else if ( el.contains(caretDown) ) {
            el.replaceChild(caretUp, caretDown);
            return direction = false;
        } else {
            el.appendChild(caretDown);
            return direction = true;
        }
    }

    // provide some symbology for column based on sorted values
    // uses https://github.com/anomal/RainbowVis-JS
    function symbolizeColumn(el, table, column) {
        var rainbow = new Rainbow();
        rainbow.setSpectrum('#fd9196', '#9aff9b');
        var rows = table.rows.length - 1;
        rainbow.setNumberRange(1, rows);
        // loop through cells and change background color
        // start at one to skip the header
        for (var i = 1; i <= rows; i++) {
            // get hex color
            var hex = '#' + rainbow.colourAt(i);
            // get cell
            var cell = table.getElementsByTagName('tr')[i].getElementsByTagName('td')[column];
            cell.style.background = hex;
        }
    }




    // weights driving calculations
    var data = {
        AB: {
            Intercept: 27.1665018,
            CN: 0.8936592,
            PW: 0.9863651,
            LH: 1.4264479,
            RH: 1.1459426,
            BE: 0.8424884,
            DU: 1.1555163,
            HE: 0.9948427
        },
        AVG: { // Rsq: 0.2865625
            Intercept: 0.1728766596,
            CN: 0.0003839499,
            LH: 0.0003243733,
            RH: 0.0004827432,
            BE: 0.0003075926
        },
        OBP: { // Rsq: 0.4673254
            Intercept: 0.1956397915,
            CN: 0.0005087604,
            LH: 0.0002599466,
            RH: 0.0003976977,
            BE: 0.0009669389
        },
        SLG: { // Rsq: 0.6130545
            Intercept: 0.0974892089,
            CN: 0.0006297989,
            PW: 0.0026319232,
            LH: 0.0004079642,
            RH: 0.0007703233,
            BE: 0.0005397229,
            SP: 0.0003424358
        },
        Rc27: {
            Intercept: 21.89611467,
            CN: 0.12340745,
            PW: 0.09589677,
            LH: 0.10247291,
            RH: 0.05994001,
            BE: 0.11927317,
            DU: 0.11651043,
            HE: 0.15890700
        },
        WHIP: { // Adj. Rsq: 0.2841573
            Intercept: 2.5978237473,
            CT: -0.0047886338,
            'LH.1': -0.0021603048,
            'RH.1': -0.0068806281,
            VE: 0.0003737825,
            P1: -0.0016857023,
            P2: -0.0011738003
        },
        OPS: { // Adj. Rsq: 0.313896
            Intercept: 1.2937001155,
            ST: 0.0002060046,
            CT: -0.0010762807,
            'LH.1': -0.0011325101,
            'RH.1': -0.0034113419,
            GB: -0.0002711084,
            P1: -0.0011536711,
            P2: -0.0006881799
        },
        FIP: { // Adj. Rsq: 0.300334
            Intercept: 9.619598945,
            CT: -0.017957664,
            'LH.1': -0.006937385,
            'RH.1': -0.025560365,
            VE: -0.003169440,
            GB: -0.003670697,
            P1: -0.008737261,
            P2: -0.005429195,
            P5: 0.001920657
        }
    }

    /*
    RainbowVis-JS
    Released under Eclipse Public License - v 1.0
    */

    function Rainbow()
    {
        "use strict";
        var gradients = null;
        var minNum = 0;
        var maxNum = 100;
        var colours = ['ff0000', 'ffff00', '00ff00', '0000ff'];
        setColours(colours);

        function setColours (spectrum)
        {
            if (spectrum.length < 2) {
                throw new Error('Rainbow must have two or more colours.');
            } else {
                var increment = (maxNum - minNum)/(spectrum.length - 1);
                var firstGradient = new ColourGradient();
                firstGradient.setGradient(spectrum[0], spectrum[1]);
                firstGradient.setNumberRange(minNum, minNum + increment);
                gradients = [ firstGradient ];

                for (var i = 1; i < spectrum.length - 1; i++) {
                    var colourGradient = new ColourGradient();
                    colourGradient.setGradient(spectrum[i], spectrum[i + 1]);
                    colourGradient.setNumberRange(minNum + increment * i, minNum + increment * (i + 1));
                    gradients[i] = colourGradient;
                }

                colours = spectrum;
            }
        }

        this.setSpectrum = function ()
        {
            setColours(arguments);
            return this;
        }

        this.setSpectrumByArray = function (array)
        {
            setColours(array);
            return this;
        }

        this.colourAt = function (number)
        {
            if (isNaN(number)) {
                throw new TypeError(number + ' is not a number');
            } else if (gradients.length === 1) {
                return gradients[0].colourAt(number);
            } else {
                var segment = (maxNum - minNum)/(gradients.length);
                var index = Math.min(Math.floor((Math.max(number, minNum) - minNum)/segment), gradients.length - 1);
                return gradients[index].colourAt(number);
            }
        }

        this.colorAt = this.colourAt;

        this.setNumberRange = function (minNumber, maxNumber)
        {
            if (maxNumber > minNumber) {
                minNum = minNumber;
                maxNum = maxNumber;
                setColours(colours);
            } else {
                throw new RangeError('maxNumber (' + maxNumber + ') is not greater than minNumber (' + minNumber + ')');
            }
            return this;
        }
    }

    function ColourGradient()
    {
        "use strict";
        var startColour = 'ff0000';
        var endColour = '0000ff';
        var minNum = 0;
        var maxNum = 100;

        this.setGradient = function (colourStart, colourEnd)
        {
            startColour = getHexColour(colourStart);
            endColour = getHexColour(colourEnd);
        }

        this.setNumberRange = function (minNumber, maxNumber)
        {
            if (maxNumber > minNumber) {
                minNum = minNumber;
                maxNum = maxNumber;
            } else {
                throw new RangeError('maxNumber (' + maxNumber + ') is not greater than minNumber (' + minNumber + ')');
            }
        }

        this.colourAt = function (number)
        {
            return calcHex(number, startColour.substring(0,2), endColour.substring(0,2))
                + calcHex(number, startColour.substring(2,4), endColour.substring(2,4))
                + calcHex(number, startColour.substring(4,6), endColour.substring(4,6));
        }

        function calcHex(number, channelStart_Base16, channelEnd_Base16)
        {
            var num = number;
            if (num < minNum) {
                num = minNum;
            }
            if (num > maxNum) {
                num = maxNum;
            }
            var numRange = maxNum - minNum;
            var cStart_Base10 = parseInt(channelStart_Base16, 16);
            var cEnd_Base10 = parseInt(channelEnd_Base16, 16);
            var cPerUnit = (cEnd_Base10 - cStart_Base10)/numRange;
            var c_Base10 = Math.round(cPerUnit * (num - minNum) + cStart_Base10);
            return formatHex(c_Base10.toString(16));
        }

        function formatHex(hex)
        {
            if (hex.length === 1) {
                return '0' + hex;
            } else {
                return hex;
            }
        }

        function isHexColour(string)
        {
            var regex = /^#?[0-9a-fA-F]{6}$/i;
            return regex.test(string);
        }

        function getHexColour(string)
        {
            if (isHexColour(string)) {
                return string.substring(string.length - 6, string.length);
            } else {
                var name = string.toLowerCase();
                if (colourNames.hasOwnProperty(name)) {
                    return colourNames[name];
                }
                throw new Error(string + ' is not a valid colour.');
            }
        }

        // Extended list of CSS colornames s taken from
        // http://www.w3.org/TR/css3-color/#svg-color
        var colourNames = {
            aliceblue: "F0F8FF",
            antiquewhite: "FAEBD7",
            aqua: "00FFFF",
            aquamarine: "7FFFD4",
            azure: "F0FFFF",
            beige: "F5F5DC",
            bisque: "FFE4C4",
            black: "000000",
            blanchedalmond: "FFEBCD",
            blue: "0000FF",
            blueviolet: "8A2BE2",
            brown: "A52A2A",
            burlywood: "DEB887",
            cadetblue: "5F9EA0",
            chartreuse: "7FFF00",
            chocolate: "D2691E",
            coral: "FF7F50",
            cornflowerblue: "6495ED",
            cornsilk: "FFF8DC",
            crimson: "DC143C",
            cyan: "00FFFF",
            darkblue: "00008B",
            darkcyan: "008B8B",
            darkgoldenrod: "B8860B",
            darkgray: "A9A9A9",
            darkgreen: "006400",
            darkgrey: "A9A9A9",
            darkkhaki: "BDB76B",
            darkmagenta: "8B008B",
            darkolivegreen: "556B2F",
            darkorange: "FF8C00",
            darkorchid: "9932CC",
            darkred: "8B0000",
            darksalmon: "E9967A",
            darkseagreen: "8FBC8F",
            darkslateblue: "483D8B",
            darkslategray: "2F4F4F",
            darkslategrey: "2F4F4F",
            darkturquoise: "00CED1",
            darkviolet: "9400D3",
            deeppink: "FF1493",
            deepskyblue: "00BFFF",
            dimgray: "696969",
            dimgrey: "696969",
            dodgerblue: "1E90FF",
            firebrick: "B22222",
            floralwhite: "FFFAF0",
            forestgreen: "228B22",
            fuchsia: "FF00FF",
            gainsboro: "DCDCDC",
            ghostwhite: "F8F8FF",
            gold: "FFD700",
            goldenrod: "DAA520",
            gray: "808080",
            green: "008000",
            greenyellow: "ADFF2F",
            grey: "808080",
            honeydew: "F0FFF0",
            hotpink: "FF69B4",
            indianred: "CD5C5C",
            indigo: "4B0082",
            ivory: "FFFFF0",
            khaki: "F0E68C",
            lavender: "E6E6FA",
            lavenderblush: "FFF0F5",
            lawngreen: "7CFC00",
            lemonchiffon: "FFFACD",
            lightblue: "ADD8E6",
            lightcoral: "F08080",
            lightcyan: "E0FFFF",
            lightgoldenrodyellow: "FAFAD2",
            lightgray: "D3D3D3",
            lightgreen: "90EE90",
            lightgrey: "D3D3D3",
            lightpink: "FFB6C1",
            lightsalmon: "FFA07A",
            lightseagreen: "20B2AA",
            lightskyblue: "87CEFA",
            lightslategray: "778899",
            lightslategrey: "778899",
            lightsteelblue: "B0C4DE",
            lightyellow: "FFFFE0",
            lime: "00FF00",
            limegreen: "32CD32",
            linen: "FAF0E6",
            magenta: "FF00FF",
            maroon: "800000",
            mediumaquamarine: "66CDAA",
            mediumblue: "0000CD",
            mediumorchid: "BA55D3",
            mediumpurple: "9370DB",
            mediumseagreen: "3CB371",
            mediumslateblue: "7B68EE",
            mediumspringgreen: "00FA9A",
            mediumturquoise: "48D1CC",
            mediumvioletred: "C71585",
            midnightblue: "191970",
            mintcream: "F5FFFA",
            mistyrose: "FFE4E1",
            moccasin: "FFE4B5",
            navajowhite: "FFDEAD",
            navy: "000080",
            oldlace: "FDF5E6",
            olive: "808000",
            olivedrab: "6B8E23",
            orange: "FFA500",
            orangered: "FF4500",
            orchid: "DA70D6",
            palegoldenrod: "EEE8AA",
            palegreen: "98FB98",
            paleturquoise: "AFEEEE",
            palevioletred: "DB7093",
            papayawhip: "FFEFD5",
            peachpuff: "FFDAB9",
            peru: "CD853F",
            pink: "FFC0CB",
            plum: "DDA0DD",
            powderblue: "B0E0E6",
            purple: "800080",
            red: "FF0000",
            rosybrown: "BC8F8F",
            royalblue: "4169E1",
            saddlebrown: "8B4513",
            salmon: "FA8072",
            sandybrown: "F4A460",
            seagreen: "2E8B57",
            seashell: "FFF5EE",
            sienna: "A0522D",
            silver: "C0C0C0",
            skyblue: "87CEEB",
            slateblue: "6A5ACD",
            slategray: "708090",
            slategrey: "708090",
            snow: "FFFAFA",
            springgreen: "00FF7F",
            steelblue: "4682B4",
            tan: "D2B48C",
            teal: "008080",
            thistle: "D8BFD8",
            tomato: "FF6347",
            turquoise: "40E0D0",
            violet: "EE82EE",
            wheat: "F5DEB3",
            white: "FFFFFF",
            whitesmoke: "F5F5F5",
            yellow: "FFFF00",
            yellowgreen: "9ACD32"
        }
    }


    </script>

</body>

</html>
